node('maven') {
  stage 'build'
    openshiftBuild(buildConfig: 'nauticalchart-fixed', showBuildLogs: 'true')
  stage('Test') {
    sh "oc get route nauticalchart-fixed -o jsonpath='{ .spec.host }' > routehost"
    routeHost = readFile('routehost').trim()
    input message: "Test <a href='http://${routeHost}'>canary deployment</a><br/> . Approve?", id: "approval"
  }
  stage('deploy') {
    openshiftDeploy(deploymentConfig: 'nauticalchart-fixed')
    openshiftScale(deploymentConfig: 'nauticalchart-fixed',replicaCount: '2')
  }
  stage('Go Live') {
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=10 nauticalchart-original=90"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=20 nauticalchart-original=80"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=30 nauticalchart-original=70"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=40 nauticalchart-original=60"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=50 nauticalchart-original=50"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=60 nauticalchart-original=40"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=70 nauticalchart-original=30"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=80 nauticalchart-original=20"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=90 nauticalchart-original=10"
    sleep 2
    sh "oc set route-backends nauticalchart-fixed nauticalchart-fixed=100 nauticalchart-original=0"
  }
  stage('Remove original') {
    openshiftDeleteResourceByKey(types: 'deploymentConfig', keys: 'nauticalchart-original')
  }
  
}